---
layout: post
title: Komplex Malware Analysis
date: 2016-09-29 11:38:22.000000000 +09:00
type: post
published: true
status: publish
categories:
- Malware Analysis
tags: []
meta:
  _edit_last: '1'
  pyre_show_first_featured_image: 'no'
  pyre_portfolio_width_100: default
  pyre_video: ''
  pyre_fimg_width: ''
  pyre_fimg_height: ''
  pyre_image_rollover_icons: default
  pyre_link_icon_url: ''
  pyre_post_links_target: 'no'
  pyre_related_posts: default
  pyre_share_box: default
  pyre_post_pagination: default
  pyre_author_info: default
  pyre_post_meta: default
  pyre_post_comments: default
  pyre_main_top_padding: ''
  pyre_main_bottom_padding: ''
  pyre_hundredp_padding: ''
  pyre_slider_position: default
  pyre_slider_type: 'no'
  pyre_slider: '0'
  pyre_wooslider: '0'
  pyre_revslider: '0'
  pyre_elasticslider: '0'
  pyre_fallback: ''
  pyre_avada_rev_styles: default
  pyre_display_header: 'yes'
  pyre_header_100_width: default
  pyre_header_bg: ''
  pyre_header_bg_color: ''
  pyre_header_bg_opacity: ''
  pyre_header_bg_full: 'no'
  pyre_header_bg_repeat: repeat
  pyre_displayed_menu: default
  pyre_display_footer: default
  pyre_display_copyright: default
  pyre_footer_100_width: default
  pyre_sidebar_position: default
  pyre_sidebar_bg_color: ''
  pyre_page_bg_layout: default
  pyre_page_bg: ''
  pyre_page_bg_color: ''
  pyre_page_bg_full: 'no'
  pyre_page_bg_repeat: repeat
  pyre_wide_page_bg: ''
  pyre_wide_page_bg_color: ''
  pyre_wide_page_bg_full: 'no'
  pyre_wide_page_bg_repeat: repeat
  pyre_page_title: default
  pyre_page_title_text: default
  pyre_page_title_text_alignment: default
  pyre_page_title_100_width: default
  pyre_page_title_custom_text: ''
  pyre_page_title_text_size: ''
  pyre_page_title_custom_subheader: ''
  pyre_page_title_custom_subheader_text_size: ''
  pyre_page_title_font_color: ''
  pyre_page_title_height: ''
  pyre_page_title_mobile_height: ''
  pyre_page_title_bar_bg: ''
  pyre_page_title_bar_bg_retina: ''
  pyre_page_title_bar_bg_color: ''
  pyre_page_title_bar_borders_color: ''
  pyre_page_title_bar_bg_full: default
  pyre_page_title_bg_parallax: default
  pyre_page_title_breadcrumbs_search_bar: default
  fusion_builder_status: inactive
  avada_post_views_count: '681'
  sbg_selected_sidebar: a:1:{i:0;s:1:"0";}
  sbg_selected_sidebar_replacement: a:1:{i:0;s:12:"Blog Sidebar";}
  sbg_selected_sidebar_2: a:1:{i:0;s:1:"0";}
  sbg_selected_sidebar_2_replacement: a:1:{i:0;s:0:"";}
  fusion_builder_content_backup: "이 내용은 개인적으로 바이너리를 분석한 내용으로 상세한 내용은 다음 글을 참조 바람.\r\n\r\n<a
    href=\"http://researchcenter.paloaltonetworks.com/2016/09/unit42-sofacys-komplex-os-x-trojan/\">Sofacy’s
    ‘Komplex’ OS X Trojan - Paloalto Networks</a>\r\n\r\n<a href=\"https://blog.malwarebytes.com/threat-analysis/2016/09/komplex-mac-backdoor-answers-old-questions/\">Komplex
    Mac backdoor answers old questions - Malware Bytes</a>\r\n<h2 id=\"section\">라운드
    1</h2>\r\n<ul>\r\n \t<li>MD5 (2a06f142d87bd9b66621a30088683d6fcec019ba5cc9e5793e54f8d920ab0134.bin)
    = 81749e780d27ddd15973d19de77c9007</li>\r\n \t<li>MachO 파일을 ‘/tmp/content’ 에 드롭,
    실행 권한(755) 부여</li>\r\n \t<li>사용자 다운로드 디렉터리의 “roskosmos_2015-2025.app” 디렉터리를 삭제</li>\r\n
    \t<li>드롭퍼에 내장된 PDF 파일을 사용자 다운로드 디렉터리에 ‘roskosmos_2015-2025.pdf’로 생성</li>\r\n \t<li>SetFile
    명령어(Deprecated)를 이용하여 PDF 파일에 숨김 속성을 부여</li>\r\n \t<li>‘/tmp/content’ 파일을 실행</li>\r\n
    \t<li>‘open’ 명령어를 이용하여 PDF 파일을 미리보기 앱에서 보이도록 함. PDF 파일은 러시아 로켓 관련 내용임.</li>\r\n
    \t<li>자기 자신을 삭제</li>\r\n</ul>\r\n<h2 id=\"section-1\">라운드 2</h2>\r\n<ul>\r\n \t<li>MD5
    (content) = 4400ec9c4732a32149ca58e7c5806178</li>\r\n \t<li>‘mkdir -p /Users/Shared/.local/
    &amp;&gt; /dev/null’</li>\r\n \t<li>“mkdir -p ~/Library/LaunchAgents/ &amp;&gt;
    /dev/null”</li>\r\n \t<li>파일 내부에 있는 Mach O 파일을 ‘/Users/Shared/.local/kextd’에 저장</li>\r\n
    \t<li>자동실행을 위한 프로퍼티 리스트 생성. 경로는 ‘/Users/Shared/com.apple.updates.plist’</li>\r\n
    \t<li>프로퍼티 리스트를 LaunchAgent로 실행하는 쉘 스크립트 생성. 경로는 ‘/Users/Shared/start.sh’</li>\r\n
    \t<li>cp /Users/Shared/com.apple.updates.plist $HOME/Library/LaunchAgents/ &amp;&gt;/dev/null</li>\r\n
    \t<li>“/Users/Shared/com.apple.updates.plist” 삭제</li>\r\n \t<li>쉘 스크립트와 MachO
    파일에 실행권한(755) 부여</li>\r\n \t<li>‘/Users/Shared/start.sh’ 실행 -&gt; 이 과정에서 다음 스테이지로
    이동</li>\r\n \t<li>‘/Users/Shared/start.sh’ 삭제</li>\r\n \t<li>자기 자신을 삭제</li>\r\n</ul>\r\n<h2
    id=\"section-2\">라운드 3(마지막)</h2>\r\n<ul>\r\n \t<li>MD5 (kextd) = b09fe828904a38f37b7a6f6933188279</li>\r\n
    \t<li>디버거가 연결되어 있는지 확인 후 있으면 자가지신을 삭제하고 종료(함수 이름은 ‘AmIBeingDebugged’)함. 코드는 <a
    href=\"https://coredump.gr/articles/ios-anti-debugging-protections-part-2/\">iOS
    Anti-Debugging Protections</a> 와 거의 동일</li>\r\n \t<li>0.06초 간격으로 ‘http://www.google.com’
    에 연결 테스트</li>\r\n \t<li>설정 정보를 복호화하여 접속할 C2 서버 도메인 명 획득. 서버 주소는 ‘hxxp://appleupdate.org’</li>\r\n
    \t<li>기본적인 정보 Mac OS X, 사용자 이름을 서버에 전달</li>\r\n \t<li>URL을 생성하여 C2 서버에 전달 시 반응을
    체크, 반응이 없으면 다른 C2 서버(백업)로 연결 시도\r\n<ul>\r\n \t<li>백업 C2 서버는 ‘hxxp://apple-iclouds.net’,
    ‘hxxp://itunes-helper.net’</li>\r\n</ul>\r\n</li>\r\n \t<li>C2 서버에서 제어\r\n<ul>\r\n
    \t<li>모든 데이터는 HTTP POST 방식으로 통신</li>\r\n \t<li>전송하는 데이터는 암호화 및 Base64 인코딩</li>\r\n</ul>\r\n</li>\r\n</ul>\r\n<h3
    id=\"section-3\">설정 파일 디코딩</h3>\r\n<ul>\r\n \t<li>MD5 (configfile) = ef3471eaddd0683fba4880a380607973</li>\r\n</ul>\r\n라운드
    3의 바이너리에 ‘0x9230 to 0x92F4’ 위치의 196 바이트를 디코딩해야 함. 디코딩 키는 11바이트의 XOR 키로 인코딩 되어
    있으며 디코딩 루틴은 다음과 같음.\r\n<div class=\"highlighter-rouge\">\r\n<pre class=\"highlight\"><code>import
    sys\r\nfrom ctypes import * \r\n\r\nclass _ConfigFile(LittleEndianStructure):\r\n
    \   _fields_ = [\r\n        ('Filename', c_ubyte*0x8),\r\n        ('PathtoSave',
    c_ubyte*10),\r\n        ('BlockShell', c_ubyte*5),\r\n        ('StartBlockFile',
    c_ubyte*6),\r\n        ('BlockExecute', c_ubyte*7),\r\n        ('BlockDelete',
    c_ubyte*6),\r\n        ('EndBlockFile', c_ubyte*7),\r\n        ('XORKEY', c_ubyte*15),\r\n
    \       ('MainServer', c_ubyte*0x18),\r\n        ('BackupServer1', c_ubyte*0x18),\r\n
    \       ('BackupServer2', c_ubyte*0x18),\r\n        ('MAC', c_ubyte*3),\r\n        ('Config',
    c_ubyte*6),\r\n        ('GetConfig', c_ubyte),\r\n        ('Files', c_ubyte*4),\r\n
    \       ('Log', c_ubyte*3),\r\n        ('OldConfig', c_ubyte*1),\r\n        ('ID',
    c_ubyte*2),\r\n        ('Token', c_ubyte*10),\r\n        ('Dummy', c_ubyte*10),\t#
    Unused\r\n        ('Extensions', c_ubyte*20)\r\n    ]\r\n\r\ndef _memcpy(buf,
    fmt):\r\n    return cast(c_char_p(buf), POINTER(fmt)).contents\r\n\r\nxorkey =
    [0x60, 0x55, 0x66, 0x45, 0x53, 0x19, 0x01, 0x72, 0x6C, 0x46, 0x3E]\r\nxorsize
    = len(xorkey)\r\n\r\n### MD5 (configfile) = ef3471eaddd0683fba4880a380607973\r\n###
    config file offset : 0x9230 to 0x92F4 (196 bytes)\r\nf = open('configfile', 'rb')\r\nbuf
    = f.read()\r\nf.close()\r\n\r\nEncConfig = _memcpy(buf, _ConfigFile)\r\n\r\n\r\nfor
    f,t in _ConfigFile._fields_:\r\n    if f == 'Dummy' or f == 'XORKEY':\r\n        continue\r\n
    \   field = getattr(_ConfigFile, f)\r\n    offset = field.offset\r\n    datasize
    = field.size\r\n    output = ''\r\n    if f == 'Extensions':\r\n        for fileoff
    in xrange(0, datasize):\r\n            output += chr((ord(buf[offset+fileoff])
    ^ xorkey[fileoff%5]));\r\n    else:\t\r\n        for fileoff in xrange(0, datasize):\r\n
    \           output += chr((ord(buf[offset+fileoff]) ^ xorkey[fileoff%xorsize]));\r\n\r\n
    \   print '%s : %s'%(f, output.replace('x00','')) \t# print type\r\n</code></pre>\r\n</div>\r\n수행
    결과\r\n<div class=\"highlighter-rouge\">\r\n<pre class=\"highlight\"><code>$ python
    xor.py \r\nFilename : FileName\r\nPathtoSave : PathToSave\r\nBlockShell : Shell\r\nStartBlockFile
    : [file]\r\nBlockExecute : Execute\r\nBlockDelete : Delete\r\nEndBlockFile : [/file]\r\nMainServer
    : appleupdate.org\r\nBackupServer1 : apple-iclouds.net\r\nBackupServer2 : itunes-helper.net\r\nMAC
    : mac\r\nConfig : config\r\nGetConfig : 1\r\nFiles : file\r\nLog : log\r\nOldConfig
    : 2\r\nID : id\r\nToken : h8sn3vq6kl\r\nExtensions : .xml.pdf.htm.zip</code></pre>\r\n</div>\r\n</div>"
  fusion_builder_converted: 'yes'
author:
  login: n0fate
  email: rapfer@gmail.com
  display_name: n0fate
  first_name: ''
  last_name: ''
---
<p>이 내용은 개인적으로 바이너리를 분석한 내용으로 상세한 내용은 다음 글을 참조 바람.</p>
<p><a href="http://researchcenter.paloaltonetworks.com/2016/09/unit42-sofacys-komplex-os-x-trojan/">Sofacy’s ‘Komplex’ OS X Trojan - Paloalto Networks</a></p>
<p><a href="https://blog.malwarebytes.com/threat-analysis/2016/09/komplex-mac-backdoor-answers-old-questions/">Komplex Mac backdoor answers old questions - Malware Bytes</a></p>
<h2 id="section">라운드 1</h2>
<ul>
<li>MD5 (2a06f142d87bd9b66621a30088683d6fcec019ba5cc9e5793e54f8d920ab0134.bin) = 81749e780d27ddd15973d19de77c9007</li>
<li>MachO 파일을 ‘/tmp/content’ 에 드롭, 실행 권한(755) 부여</li>
<li>사용자 다운로드 디렉터리의 “roskosmos_2015-2025.app” 디렉터리를 삭제</li>
<li>드롭퍼에 내장된 PDF 파일을 사용자 다운로드 디렉터리에 ‘roskosmos_2015-2025.pdf’로 생성</li>
<li>SetFile 명령어(Deprecated)를 이용하여 PDF 파일에 숨김 속성을 부여</li>
<li>‘/tmp/content’ 파일을 실행</li>
<li>‘open’ 명령어를 이용하여 PDF 파일을 미리보기 앱에서 보이도록 함. PDF 파일은 러시아 로켓 관련 내용임.</li>
<li>자기 자신을 삭제</li>
</ul>
<h2 id="section-1">라운드 2</h2>
<ul>
<li>MD5 (content) = 4400ec9c4732a32149ca58e7c5806178</li>
<li>‘mkdir -p /Users/Shared/.local/ &amp;&gt; /dev/null’</li>
<li>“mkdir -p ~/Library/LaunchAgents/ &amp;&gt; /dev/null”</li>
<li>파일 내부에 있는 Mach O 파일을 ‘/Users/Shared/.local/kextd’에 저장</li>
<li>자동실행을 위한 프로퍼티 리스트 생성. 경로는 ‘/Users/Shared/com.apple.updates.plist’</li>
<li>프로퍼티 리스트를 LaunchAgent로 실행하는 쉘 스크립트 생성. 경로는 ‘/Users/Shared/start.sh’</li>
<li>cp /Users/Shared/com.apple.updates.plist $HOME/Library/LaunchAgents/ &amp;&gt;/dev/null</li>
<li>“/Users/Shared/com.apple.updates.plist” 삭제</li>
<li>쉘 스크립트와 MachO 파일에 실행권한(755) 부여</li>
<li>‘/Users/Shared/start.sh’ 실행 -&gt; 이 과정에서 다음 스테이지로 이동</li>
<li>‘/Users/Shared/start.sh’ 삭제</li>
<li>자기 자신을 삭제</li>
</ul>
<h2 id="section-2">라운드 3(마지막)</h2>
<ul>
<li>MD5 (kextd) = b09fe828904a38f37b7a6f6933188279</li>
<li>디버거가 연결되어 있는지 확인 후 있으면 자가지신을 삭제하고 종료(함수 이름은 ‘AmIBeingDebugged’)함. 코드는 <a href="https://coredump.gr/articles/ios-anti-debugging-protections-part-2/">iOS Anti-Debugging Protections</a> 와 거의 동일</li>
<li>0.06초 간격으로 ‘http://www.google.com’ 에 연결 테스트</li>
<li>설정 정보를 복호화하여 접속할 C2 서버 도메인 명 획득. 서버 주소는 ‘hxxp://appleupdate.org’</li>
<li>기본적인 정보 Mac OS X, 사용자 이름을 서버에 전달</li>
<li>URL을 생성하여 C2 서버에 전달 시 반응을 체크, 반응이 없으면 다른 C2 서버(백업)로 연결 시도
<ul>
<li>백업 C2 서버는 ‘hxxp://apple-iclouds.net’, ‘hxxp://itunes-helper.net’</li>
</ul>
</li>
<li>C2 서버에서 제어
<ul>
<li>모든 데이터는 HTTP POST 방식으로 통신</li>
<li>전송하는 데이터는 암호화 및 Base64 인코딩</li>
</ul>
</li>
</ul>
<h3 id="section-3">설정 파일 디코딩</h3>
<ul>
<li>MD5 (configfile) = ef3471eaddd0683fba4880a380607973</li>
</ul>
<p>라운드 3의 바이너리에 ‘0x9230 to 0x92F4’ 위치의 196 바이트를 디코딩해야 함. 디코딩 키는 11바이트의 XOR 키로 인코딩 되어 있으며 디코딩 루틴은 다음과 같음.</p>
<div class="highlighter-rouge">
<pre class="highlight"><code>import sys
from ctypes import * 

class _ConfigFile(LittleEndianStructure):
    _fields_ = [fusion_builder_container hundred_percent="yes" overflow="visible"][fusion_builder_row][fusion_builder_column type="1_1" background_position="left top" background_color="" border_size="" border_color="" border_style="solid" spacing="yes" background_image="" background_repeat="no-repeat" padding="" margin_top="0px" margin_bottom="0px" class="" id="" animation_type="" animation_speed="0.3" animation_direction="left" hide_on_mobile="no" center_content="no" min_height="none"][
        ('Filename', c_ubyte*0x8),
        ('PathtoSave', c_ubyte*10),
        ('BlockShell', c_ubyte*5),
        ('StartBlockFile', c_ubyte*6),
        ('BlockExecute', c_ubyte*7),
        ('BlockDelete', c_ubyte*6),
        ('EndBlockFile', c_ubyte*7),
        ('XORKEY', c_ubyte*15),
        ('MainServer', c_ubyte*0x18),
        ('BackupServer1', c_ubyte*0x18),
        ('BackupServer2', c_ubyte*0x18),
        ('MAC', c_ubyte*3),
        ('Config', c_ubyte*6),
        ('GetConfig', c_ubyte),
        ('Files', c_ubyte*4),
        ('Log', c_ubyte*3),
        ('OldConfig', c_ubyte*1),
        ('ID', c_ubyte*2),
        ('Token', c_ubyte*10),
        ('Dummy', c_ubyte*10),	# Unused
        ('Extensions', c_ubyte*20)
    ]

def _memcpy(buf, fmt):
    return cast(c_char_p(buf), POINTER(fmt)).contents

xorkey = [0x60, 0x55, 0x66, 0x45, 0x53, 0x19, 0x01, 0x72, 0x6C, 0x46, 0x3E]
xorsize = len(xorkey)

### MD5 (configfile) = ef3471eaddd0683fba4880a380607973
### config file offset : 0x9230 to 0x92F4 (196 bytes)
f = open('configfile', 'rb')
buf = f.read()
f.close()

EncConfig = _memcpy(buf, _ConfigFile)


for f,t in _ConfigFile._fields_:
    if f == 'Dummy' or f == 'XORKEY':
        continue
    field = getattr(_ConfigFile, f)
    offset = field.offset
    datasize = field.size
    output = ''
    if f == 'Extensions':
        for fileoff in xrange(0, datasize):
            output += chr((ord(buf[offset+fileoff]) ^ xorkey[fileoff%5]));
    else:	
        for fileoff in xrange(0, datasize):
            output += chr((ord(buf[offset+fileoff]) ^ xorkey[fileoff%xorsize]));

    print '%s : %s'%(f, output.replace('\x00','')) 	# print type
</code></pre>
</div>
<p>수행 결과</p>
<div class="highlighter-rouge">
<pre class="highlight"><code>$ python xor.py 
Filename : FileName
PathtoSave : PathToSave
BlockShell : Shell
StartBlockFile : [file]
BlockExecute : Execute
BlockDelete : Delete
EndBlockFile : [/file]
MainServer : appleupdate.org
BackupServer1 : apple-iclouds.net
BackupServer2 : itunes-helper.net
MAC : mac
Config : config
GetConfig : 1
Files : file
Log : log
OldConfig : 2
ID : id
Token : h8sn3vq6kl
Extensions : .xml.pdf.htm.zip</code></pre>
</div>
<p>[/fusion_builder_column][/fusion_builder_row][/fusion_builder_container]</p>
